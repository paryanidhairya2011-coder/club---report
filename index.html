<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Expense Tracker (Shared)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better readability and table design */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            padding: 2rem;
        }
        .table-header {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            font-weight: 600;
        }
        .table-cell {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        /* Style for the "OWES" and "OWED" status */
        .status-owed {
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 800 */
            font-weight: 700;
        }
        .status-owes {
            background-color: #fee2e2; /* Red 100 */
            color: #991b1b; /* Red 800 */
            font-weight: 700;
        }
        .input-field {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto">
        <header class="text-center mb-8 p-4 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-gray-800">ðŸ’° Club Expense Tracker (Shared)</h1>
            <p class="text-gray-500 mt-2">Tracking expenses for Angie, Paiton, Vinh, Dhruv, Dhairya, Sarvesh, Arnav, and Sebastian (8 members).</p>
            <p class="text-xs mt-2 text-gray-400">Your User ID: <span id="user-id-display" class="font-mono text-gray-600">Loading...</span></p>
        </header>

        <!-- Form to Add New Transaction -->
        <section class="mb-10 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-green-600">Add New Expense</h2>
            <form id="add-transaction-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <input type="text" id="desc-input" required placeholder="Pizza, Supplies, etc." class="input-field">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Buyer</label>
                    <select id="buyer-input" required class="input-field">
                        <option value="" disabled selected>Select Buyer</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cost ($)</label>
                    <input type="number" id="cost-input" required min="0.01" step="0.01" placeholder="e.g., 25.50" class="input-field">
                </div>
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Split By (Count)</label>
                    <input type="number" id="split-count-input" required min="1" max="8" value="8" class="input-field text-center">
                </div>
                <div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200">
                        Add Transaction
                    </button>
                </div>
            </form>
            <p class="text-sm text-gray-500 mt-4">Note: Currently, all transactions are split equally among the number of people you specify. For simplicity, we assume the members are the first N people in the full list.</p>
        </section>
        
        <!-- Transaction Log Section -->
        <section class="mb-10 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-600">2. Transaction Log (Saved Data)</h2>
            <div id="loading-indicator" class="text-center py-8 text-gray-500">
                Loading transactions...
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg hidden" id="transaction-table">
                    <thead>
                        <tr id="log-header" class="table-header">
                            <th class="table-cell rounded-tl-xl text-left">Date</th>
                            <th class="table-cell text-left">Item Description</th>
                            <th class="table-cell text-left">Buyer</th>
                            <th class="table-cell text-right">Cost (USD)</th>
                            <th class="table-cell text-center">Split Among (Count)</th>
                            <th class="table-cell rounded-tr-xl text-right">Cost Per Person (A)</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-log-body" class="bg-white divide-y divide-gray-200">
                        <!-- Transaction rows will be injected here -->
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-50 font-bold">
                            <td colspan="3" class="table-cell text-right text-gray-700">TOTAL EXPENSES:</td>
                            <td id="total-cost" class="table-cell text-right text-lg text-blue-600"></td>
                            <td colspan="2" class="table-cell"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

        <!-- Summary Calculation Section -->
        <section class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 border-b pb-2 text-blue-600">3. Individual Expense Summary (Final Balances)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg">
                    <thead>
                        <tr class="table-header">
                            <th class="table-cell rounded-tl-xl text-left">Member</th>
                            <th class="table-cell text-right">Total Paid Out (Credit) (B)</th>
                            <th class="table-cell text-right">Total Share Owed (Debit) (C)</th>
                            <th class="table-cell rounded-tr-xl text-right">Net Balance (B - C)</th>
                            <th class="table-cell text-center">Final Status</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Summary rows will be injected here -->
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-50 font-bold">
                            <td class="table-cell text-right text-gray-700">GRAND TOTAL:</td>
                            <td id="total-paid-out" class="table-cell text-right"></td>
                            <td id="total-owed" class="table-cell text-right"></td>
                            <td id="net-balance-check" class="table-cell text-right"></td>
                            <td class="table-cell"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Initialization
        let app;
        let db;
        let auth;
        let transactionsRef;
        let currentUserId = null;

        // Array of all 8 club members (Static for this app)
        const members = ["Angie", "Paiton", "Vinh", "Dhruv", "Dhairya", "Sarvesh", "Arnav", "Sebastian"];

        // The path for public/shared data
        const COLLECTION_PATH = `/artifacts/${appId}/public/data/club_transactions`;

        // Utility function to format numbers as currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount || 0);
        };

        // --- AUTHENTICATION AND INIT ---
        
        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                transactionsRef = collection(db, COLLECTION_PATH);

                // Populate the buyer dropdown once Firebase is set up
                populateBuyerDropdown();

                // Listen for authentication changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('user-id-display').textContent = currentUserId;
                        console.log("User authenticated:", currentUserId);
                        // Once authenticated, start listening to data
                        loadTransactions(); 
                    } else {
                        // Attempt to sign in
                        if (initialAuthToken) {
                            signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                console.error("Custom token sign in failed. Trying anonymous.", e);
                                signInAnonymously(auth).then(u => {
                                    console.log("Signed in anonymously.");
                                }).catch(e => console.error("Anonymous sign in failed.", e));
                            });
                        } else {
                            signInAnonymously(auth).then(u => {
                                console.log("Signed in anonymously (no token).");
                            }).catch(e => console.error("Anonymous sign in failed.", e));
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }
        
        // --- DATA INPUT ---

        function populateBuyerDropdown() {
            const select = document.getElementById('buyer-input');
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member;
                option.textContent = member;
                select.appendChild(option);
            });
        }

        document.getElementById('add-transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const desc = document.getElementById('desc-input').value.trim();
            const buyer = document.getElementById('buyer-input').value;
            const cost = parseFloat(document.getElementById('cost-input').value);
            const splitCount = parseInt(document.getElementById('split-count-input').value, 10);
            
            if (!desc || !buyer || isNaN(cost) || cost <= 0 || isNaN(splitCount) || splitCount < 1 || !db) {
                console.error("Invalid input or database not ready.");
                return;
            }

            // Determine which members are included in the split (for simplicity, we use the first N members)
            const splitForMembers = members.slice(0, splitCount);

            const newTransaction = {
                date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                desc: desc,
                buyer: buyer,
                cost: cost,
                splitCount: splitCount,
                // Store the list of people included, which is the key to accurate calculation
                splitFor: splitForMembers, 
                // Metadata
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(transactionsRef, newTransaction);
                document.getElementById('add-transaction-form').reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });

        // --- DATA FETCHING (Real-time) ---

        function loadTransactions() {
            if (!transactionsRef) return;
            
            // Listen for real-time updates
            onSnapshot(transactionsRef, (snapshot) => {
                const transactionsData = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Ensure splitFor is an array (might be corrupted if manually added, though unlikely here)
                    const splitFor = Array.isArray(data.splitFor) ? data.splitFor : members.slice(0, data.splitCount || 8);
                    
                    transactionsData.push({ 
                        ...data, 
                        id: doc.id,
                        splitFor: splitFor,
                        costPerPerson: data.cost / (data.splitCount || 1) // Calculate share immediately
                    });
                });
                
                // Sort transactions by timestamp (if available) or date
                transactionsData.sort((a, b) => {
                    if (a.timestamp && b.timestamp) {
                        return a.timestamp.seconds - b.timestamp.seconds;
                    }
                    return a.date.localeCompare(b.date);
                });

                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('transaction-table').classList.remove('hidden');

                renderTransactions(transactionsData);
                renderSummary(transactionsData);
                
            }, (error) => {
                console.error("Error listening to transactions: ", error);
                document.getElementById('loading-indicator').textContent = "Error loading data.";
            });
        }


        // --- RENDERING ---

        function renderTransactions(transactions) {
            let totalClubCost = 0;
            const logBody = document.getElementById('transaction-log-body');
            logBody.innerHTML = ''; // Clear previous rows
            
            transactions.forEach(t => {
                totalClubCost += t.cost;
                const costPerPerson = t.costPerPerson || 0;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="table-cell">${t.date}</td>
                    <td class="table-cell">${t.desc}</td>
                    <td class="table-cell font-medium">${t.buyer}</td>
                    <td class="table-cell text-right">${formatCurrency(t.cost)}</td>
                    <td class="table-cell text-center text-sm text-gray-500">${t.splitCount}</td>
                    <td class="table-cell text-right font-semibold text-blue-700">${formatCurrency(costPerPerson)}</td>
                `;
                logBody.appendChild(row);
            });

            document.getElementById('total-cost').textContent = formatCurrency(totalClubCost);
        }

        function renderSummary(transactions) {
            // 1. Initialize balances for each member
            const balances = members.map(member => ({
                name: member,
                paidOut: 0,
                shareOwed: 0,
                netBalance: 0
            }));

            // 2. Calculate Total Paid Out (Credit) and Total Share Owed (Debit)
            
            transactions.forEach(t => {
                // Calculate Total Paid Out (Credit)
                const buyerEntry = balances.find(b => b.name === t.buyer);
                if (buyerEntry) {
                    buyerEntry.paidOut += t.cost;
                }

                // Calculate Total Share Owed (Debit) - ONLY for members in the splitFor list
                t.splitFor.forEach(member => {
                    const memberEntry = balances.find(b => b.name === member);
                    if (memberEntry) {
                        memberEntry.shareOwed += t.costPerPerson;
                    }
                });
            });

            // 3. Calculate Net Balance and Render Summary Table
            const summaryBody = document.getElementById('summary-table-body');
            summaryBody.innerHTML = ''; // Clear previous rows
            let totalPaidOutCheck = 0;
            let totalOwedCheck = 0;

            balances.forEach(b => {
                b.netBalance = b.paidOut - b.shareOwed;
                
                totalPaidOutCheck += b.paidOut;
                totalOwedCheck += b.shareOwed;

                const isOwed = b.netBalance > 0.01;
                const isOwes = b.netBalance < -0.01;
                const statusText = isOwed ? 'OWED (Receives)' : (isOwes ? 'OWES (Pays)' : 'EVEN');
                const statusClass = isOwed ? 'status-owed' : (isOwes ? 'status-owes' : 'bg-gray-200 text-gray-700');

                const row = document.createElement('tr');
                row.className = 'hover:shadow-md transition-shadow duration-300';
                row.innerHTML = `
                    <td class="table-cell font-extrabold text-gray-800">${b.name}</td>
                    <td class="table-cell text-right">${formatCurrency(b.paidOut)}</td>
                    <td class="table-cell text-right">${formatCurrency(b.shareOwed)}</td>
                    <td class="table-cell text-right font-extrabold ${isOwed ? 'text-green-600' : (isOwes ? 'text-red-600' : 'text-gray-800')}">
                        ${formatCurrency(b.netBalance)}
                    </td>
                    <td class="table-cell text-center">
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                summaryBody.appendChild(row);
            });

            // 4. Update Grand Total Footer
            document.getElementById('total-paid-out').textContent = formatCurrency(totalPaidOutCheck);
            document.getElementById('total-owed').textContent = formatCurrency(totalOwedCheck);
            
            // Check should always be close to $0.00
            document.getElementById('net-balance-check').textContent = formatCurrency(totalPaidOutCheck - totalOwedCheck); 
        }

        // Start everything up
        initFirebase();

        
        // Initial hardcoded data insertion (Run only once to populate the tracker for the first time)
        // This block adds the sample data from the previous step if the collection is empty.
        async function checkAndSeedData() {
            try {
                if (!db || !transactionsRef) return;
                
                // Sample data based on your previous file (only used for seeding)
                const sampleTransactions = [
                    { date: "2024-10-15", desc: "Pizza for meeting", buyer: "Dhairya", cost: 64.00, splitCount: 8, splitFor: members },
                    { date: "2024-10-15", desc: "Soft Drinks & Cups", buyer: "Dhruv", cost: 16.00, splitCount: 8, splitFor: members },
                    { date: "2024-10-22", desc: "Project Supplies", buyer: "Vinh", cost: 20.00, splitCount: 4, splitFor: ["Vinh", "Angie", "Paiton", "Arnav"] },
                    { date: "2024-10-29", desc: "Membership Renewal Fee", buyer: "Angie", cost: 120.00, splitCount: 8, splitFor: members },
                    { date: "2024-11-05", desc: "Event Banner Print", buyer: "Sarvesh", cost: 35.00, splitCount: 7, splitFor: members.filter(m => m !== "Sebastian") },
                    { date: "2024-11-05", desc: "Coffee/Snacks (Recruiting)", buyer: "Dhairya", cost: 28.00, splitCount: 4, splitFor: ["Dhairya", "Dhruv", "Sarvesh", "Sebastian"] },
                ];
                
                // Simple check: if no transactions are loaded yet, seed the data
                // WARNING: This logic relies on the onSnapshot having not yet returned data, but it's okay for a demo seed.
                // A better approach would be to fetch once with getDocs and check size. We'll stick to this for simplicity.
                // Since this runs after init, we'll try to add them if we detect no data after a short delay.
                
                setTimeout(() => {
                    if (document.getElementById('transaction-log-body').children.length === 0) {
                        console.log("Seeding initial data...");
                        sampleTransactions.forEach(t => {
                            addDoc(transactionsRef, { ...t, timestamp: serverTimestamp() }).catch(e => console.error("Error seeding data:", e));
                        });
                    }
                }, 3000); // Give time for onSnapshot to run

            } catch (error) {
                console.error("Error in checkAndSeedData:", error);
            }
        }
        
        // Run the seeding function once authorized
        onAuthStateChanged(auth, (user) => {
            if (user) {
                checkAndSeedData();
            }
        });

    </script>
</body>
</html>
